"use strict";function getCORSRequest(){if(root_1.root.XMLHttpRequest)return new root_1.root.XMLHttpRequest;if(root_1.root.XDomainRequest)return new root_1.root.XDomainRequest;throw new Error("CORS is not supported by your browser")}function getXMLHttpRequest(){if(root_1.root.XMLHttpRequest)return new root_1.root.XMLHttpRequest;var e=void 0;try{for(var r=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],t=0;t<3;t++)try{if(e=r[t],new root_1.root.ActiveXObject(e))break}catch(e){}return new root_1.root.ActiveXObject(e)}catch(e){throw new Error("XMLHttpRequest is not supported by your browser")}}function ajaxGet(e,r){return void 0===r&&(r=null),new AjaxObservable({method:"GET",url:e,headers:r})}function ajaxPost(e,r,t){return new AjaxObservable({method:"POST",url:e,body:r,headers:t})}function ajaxDelete(e,r){return new AjaxObservable({method:"DELETE",url:e,headers:r})}function ajaxPut(e,r,t){return new AjaxObservable({method:"PUT",url:e,body:r,headers:t})}function ajaxPatch(e,r,t){return new AjaxObservable({method:"PATCH",url:e,body:r,headers:t})}function ajaxGetJSON(e,r){return mapResponse(new AjaxObservable({method:"GET",url:e,responseType:"json",headers:r}))}function parseXhrResponse(e,r){switch(e){case"json":return"response"in r?r.responseType?r.response:JSON.parse(r.response||r.responseText||"null"):JSON.parse(r.responseText||"null");case"xml":return r.responseXML;case"text":default:return"response"in r?r.response:r.responseText}}var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])};return function(e,r){function t(){this.constructor=e}s(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var root_1=require("../../util/root"),tryCatch_1=require("../../util/tryCatch"),errorObject_1=require("../../util/errorObject"),Observable_1=require("../../Observable"),Subscriber_1=require("../../Subscriber"),map_1=require("../../operators/map");exports.ajaxGet=ajaxGet,exports.ajaxPost=ajaxPost,exports.ajaxDelete=ajaxDelete,exports.ajaxPut=ajaxPut,exports.ajaxPatch=ajaxPatch;var mapResponse=map_1.map(function(e,r){return e.response});exports.ajaxGetJSON=ajaxGetJSON;var AjaxObservable=function(o){function r(e){var r=o.call(this)||this,t={async:!0,createXHR:function(){return this.crossDomain?getCORSRequest.call(this):getXMLHttpRequest()},crossDomain:!1,withCredentials:!1,headers:{},method:"GET",responseType:"json",timeout:0};if("string"==typeof e)t.url=e;else for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return r.request=t,r}var e;return __extends(r,o),r.prototype._subscribe=function(e){return new AjaxSubscriber(e,this.request)},r.create=((e=function(e){return new r(e)}).get=ajaxGet,e.post=ajaxPost,e.delete=ajaxDelete,e.put=ajaxPut,e.patch=ajaxPatch,e.getJSON=ajaxGetJSON,e),r}(Observable_1.Observable);exports.AjaxObservable=AjaxObservable;var AjaxSubscriber=function(o){function e(e,r){var t=o.call(this,e)||this;t.request=r,t.done=!1;var s=r.headers=r.headers||{};return r.crossDomain||s["X-Requested-With"]||(s["X-Requested-With"]="XMLHttpRequest"),"Content-Type"in s||root_1.root.FormData&&r.body instanceof root_1.root.FormData||void 0===r.body||(s["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),r.body=t.serializeBody(r.body,r.headers["Content-Type"]),t.send(),t}return __extends(e,o),e.prototype.next=function(e){this.done=!0;var r=this,t=r.xhr,s=r.request,o=r.destination,n=new AjaxResponse(e,t,s);o.next(n)},e.prototype.send=function(){var e=this.request,r=this.request,t=r.user,s=r.method,o=r.url,n=r.async,a=r.password,i=r.headers,u=r.body,p=e.createXHR,c=tryCatch_1.tryCatch(p).call(e);if(c===errorObject_1.errorObject)this.error(errorObject_1.errorObject.e);else{this.xhr=c,this.setupEvents(c,e);if((t?tryCatch_1.tryCatch(c.open).call(c,s,o,n,t,a):tryCatch_1.tryCatch(c.open).call(c,s,o,n))===errorObject_1.errorObject)return this.error(errorObject_1.errorObject.e),null;if(n&&(c.timeout=e.timeout,c.responseType=e.responseType),"withCredentials"in c&&(c.withCredentials=!!e.withCredentials),this.setHeaders(c,i),(u?tryCatch_1.tryCatch(c.send).call(c,u):tryCatch_1.tryCatch(c.send).call(c))===errorObject_1.errorObject)return this.error(errorObject_1.errorObject.e),null}return c},e.prototype.serializeBody=function(r,e){if(!r||"string"==typeof r)return r;if(root_1.root.FormData&&r instanceof root_1.root.FormData)return r;if(e){var t=e.indexOf(";");-1!==t&&(e=e.substring(0,t))}switch(e){case"application/x-www-form-urlencoded":return Object.keys(r).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&");case"application/json":return JSON.stringify(r);default:return r}},e.prototype.setHeaders=function(e,r){for(var t in r)r.hasOwnProperty(t)&&e.setRequestHeader(t,r[t])},e.prototype.setupEvents=function(e,r){function n(e){var r=n,t=r.subscriber,s=r.progressSubscriber,o=r.request;s&&s.error(e),t.error(new AjaxTimeoutError(this,o))}function i(e){var r=i,t=r.subscriber,s=r.progressSubscriber,o=r.request;if(4===this.readyState){var n=1223===this.status?204:this.status,a="text"===this.responseType?this.response||this.responseText:this.response;0===n&&(n=a?200:0),200<=n&&n<300?(s&&s.complete(),t.next(e),t.complete()):(s&&s.error(e),t.error(new AjaxError("ajax error "+n,this,o)))}}var t=r.progressSubscriber;if((e.ontimeout=n).request=r,n.subscriber=this,n.progressSubscriber=t,e.upload&&"withCredentials"in e){var s,a;if(t)s=function(e){s.progressSubscriber.next(e)},root_1.root.XDomainRequest?e.onprogress=s:e.upload.onprogress=s,s.progressSubscriber=t;a=function(e){var r=a,t=r.progressSubscriber,s=r.subscriber,o=r.request;t&&t.error(e),s.error(new AjaxError("ajax error",this,o))},(e.onerror=a).request=r,a.subscriber=this,a.progressSubscriber=t}(e.onreadystatechange=i).subscriber=this,i.progressSubscriber=t,i.request=r},e.prototype.unsubscribe=function(){var e=this.done,r=this.xhr;!e&&r&&4!==r.readyState&&"function"==typeof r.abort&&r.abort(),o.prototype.unsubscribe.call(this)},e}(Subscriber_1.Subscriber);exports.AjaxSubscriber=AjaxSubscriber;var AjaxResponse=function(e,r,t){this.originalEvent=e,this.xhr=r,this.request=t,this.status=r.status,this.responseType=r.responseType||t.responseType,this.response=parseXhrResponse(this.responseType,r)};exports.AjaxResponse=AjaxResponse;var AjaxError=function(o){function e(e,r,t){var s=o.call(this,e)||this;return s.message=e,s.xhr=r,s.request=t,s.status=r.status,s.responseType=r.responseType||t.responseType,s.response=parseXhrResponse(s.responseType,r),s}return __extends(e,o),e}(Error),AjaxTimeoutError=function(t){function e(e,r){return t.call(this,"ajax timeout",e,r)||this}return __extends(e,t),e}(exports.AjaxError=AjaxError);exports.AjaxTimeoutError=AjaxTimeoutError;