"use strict";function pctEncChar(e){var r=e.charCodeAt(0);return r<16?"%0"+r.toString(16).toUpperCase():r<128?"%"+r.toString(16).toUpperCase():r<2048?"%"+(r>>6|192).toString(16).toUpperCase()+"%"+(63&r|128).toString(16).toUpperCase():"%"+(r>>12|224).toString(16).toUpperCase()+"%"+(r>>6&63|128).toString(16).toUpperCase()+"%"+(63&r|128).toString(16).toUpperCase()}function pctDecChars(e){for(var r="",t=0,o=e.length;t<o;){var n=parseInt(e.substr(t+1,2),16);if(n<128)r+=String.fromCharCode(n),t+=3;else if(194<=n&&n<224){if(6<=o-t){var s=parseInt(e.substr(t+4,2),16);r+=String.fromCharCode((31&n)<<6|63&s)}else r+=e.substr(t,6);t+=6}else if(224<=n){if(9<=o-t){s=parseInt(e.substr(t+4,2),16);var i=parseInt(e.substr(t+7,2),16);r+=String.fromCharCode((15&n)<<12|(63&s)<<6|63&i)}else r+=e.substr(t,9);t+=9}else r+=e.substr(t,3),t+=3}return r}function _normalizeComponentEncoding(e,t){function r(e){var r=pctDecChars(e);return r.match(t.UNRESERVED)?r:e}return e.scheme&&(e.scheme=String(e.scheme).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_SCHEME,"")),void 0!==e.userinfo&&(e.userinfo=String(e.userinfo).replace(t.PCT_ENCODED,r).replace(t.NOT_USERINFO,pctEncChar).replace(t.PCT_ENCODED,util_1.toUpperCase)),void 0!==e.host&&(e.host=String(e.host).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_HOST,pctEncChar).replace(t.PCT_ENCODED,util_1.toUpperCase)),void 0!==e.path&&(e.path=String(e.path).replace(t.PCT_ENCODED,r).replace(e.scheme?t.NOT_PATH:t.NOT_PATH_NOSCHEME,pctEncChar).replace(t.PCT_ENCODED,util_1.toUpperCase)),void 0!==e.query&&(e.query=String(e.query).replace(t.PCT_ENCODED,r).replace(t.NOT_QUERY,pctEncChar).replace(t.PCT_ENCODED,util_1.toUpperCase)),void 0!==e.fragment&&(e.fragment=String(e.fragment).replace(t.PCT_ENCODED,r).replace(t.NOT_FRAGMENT,pctEncChar).replace(t.PCT_ENCODED,util_1.toUpperCase)),e}function _stripLeadingZeros(e){return e.replace(/^0*(.*)/,"$1")||"0"}function _normalizeIPv4(e,r){var t=(e.match(r.IPV4ADDRESS)||[])[1];return t?t.split(".").map(_stripLeadingZeros).join("."):e}function _normalizeIPv6(e,r){var t=e.match(r.IPV6ADDRESS)||[],o=t[1],n=t[2];if(o){for(var s=o.toLowerCase().split("::").reverse(),i=s[0],a=s[1],p=a?a.split(":").map(_stripLeadingZeros):[],c=i.split(":").map(_stripLeadingZeros),u=r.IPV4ADDRESS.test(c[c.length-1]),h=u?7:8,l=c.length-h,f=Array(h),m=0;m<h;++m)f[m]=p[m]||c[l+m]||"";u&&(f[h-1]=_normalizeIPv4(f[h-1],r));var d=f.reduce(function(e,r,t){if(!r||"0"===r){var o=e[e.length-1];o&&o.index+o.length===t?o.length++:e.push({index:t,length:1})}return e},[]).sort(function(e,r){return r.length-e.length})[0],C=void 0;if(d&&1<d.length){var v=f.slice(0,d.index),_=f.slice(d.index+d.length);C=v.join(":")+"::"+_.join(":")}else C=f.join(":");return n&&(C+="%"+n),C}return e}function parse(e,r){void 0===r&&(r={});var t={},o=!1!==r.iri?regexps_iri_1.default:regexps_uri_1.default;"suffix"===r.reference&&(e=(r.scheme?r.scheme+":":"")+"//"+e);var n=e.match(URI_PARSE);if(n){NO_MATCH_IS_UNDEFINED?(t.scheme=n[1],t.userinfo=n[3],t.host=n[4],t.port=parseInt(n[5],10),t.path=n[6]||"",t.query=n[7],t.fragment=n[8],isNaN(t.port)&&(t.port=n[5])):(t.scheme=n[1]||void 0,t.userinfo=-1!==e.indexOf("@")?n[3]:void 0,t.host=-1!==e.indexOf("//")?n[4]:void 0,t.port=parseInt(n[5],10),t.path=n[6]||"",t.query=-1!==e.indexOf("?")?n[7]:void 0,t.fragment=-1!==e.indexOf("#")?n[8]:void 0,isNaN(t.port)&&(t.port=e.match(/\/\/(?:.|\n)*\:(?:\/|\?|\#|$)/)?n[4]:void 0)),t.host&&(t.host=_normalizeIPv6(_normalizeIPv4(t.host,o),o)),void 0!==t.scheme||void 0!==t.userinfo||void 0!==t.host||void 0!==t.port||t.path||void 0!==t.query?void 0===t.scheme?t.reference="relative":void 0===t.fragment?t.reference="absolute":t.reference="uri":t.reference="same-document",r.reference&&"suffix"!==r.reference&&r.reference!==t.reference&&(t.error=t.error||"URI is not a "+r.reference+" reference.");var s=exports.SCHEMES[(r.scheme||t.scheme||"").toLowerCase()];if(r.unicodeSupport||s&&s.unicodeSupport)_normalizeComponentEncoding(t,o);else{if(t.host&&(r.domainHost||s&&s.domainHost))try{t.host=punycode_1.default.toASCII(t.host.replace(o.PCT_ENCODED,pctDecChars).toLowerCase())}catch(e){t.error=t.error||"Host's domain name can not be converted to ASCII via punycode: "+e}_normalizeComponentEncoding(t,regexps_uri_1.default)}s&&s.parse&&s.parse(t,r)}else t.error=t.error||"URI can not be parsed.";return t}function _recomposeAuthority(e,r){var t=!1!==r.iri?regexps_iri_1.default:regexps_uri_1.default,o=[];return void 0!==e.userinfo&&(o.push(e.userinfo),o.push("@")),void 0!==e.host&&o.push(_normalizeIPv6(_normalizeIPv4(String(e.host),t),t).replace(t.IPV6ADDRESS,function(e,r,t){return"["+r+(t?"%25"+t:"")+"]"})),"number"==typeof e.port&&(o.push(":"),o.push(e.port.toString(10))),o.length?o.join(""):void 0}function removeDotSegments(e){for(var r=[];e.length;)if(e.match(RDS1))e=e.replace(RDS1,"");else if(e.match(RDS2))e=e.replace(RDS2,"/");else if(e.match(RDS3))e=e.replace(RDS3,"/"),r.pop();else if("."===e||".."===e)e="";else{var t=e.match(RDS5);if(!t)throw new Error("Unexpected dot segment condition");var o=t[0];e=e.slice(o.length),r.push(o)}return r.join("")}function serialize(r,t){void 0===t&&(t={});var e=t.iri?regexps_iri_1.default:regexps_uri_1.default,o=[],n=exports.SCHEMES[(t.scheme||r.scheme||"").toLowerCase()];if(n&&n.serialize&&n.serialize(r,t),r.host)if(e.IPV6ADDRESS.test(r.host));else if(t.domainHost||n&&n.domainHost)try{r.host=t.iri?punycode_1.default.toUnicode(r.host):punycode_1.default.toASCII(r.host.replace(e.PCT_ENCODED,pctDecChars).toLowerCase())}catch(e){r.error=r.error||"Host's domain name can not be converted to "+(t.iri?"Unicode":"ASCII")+" via punycode: "+e}_normalizeComponentEncoding(r,e),"suffix"!==t.reference&&r.scheme&&(o.push(r.scheme),o.push(":"));var s=_recomposeAuthority(r,t);if(void 0!==s&&("suffix"!==t.reference&&o.push("//"),o.push(s),r.path&&"/"!==r.path.charAt(0)&&o.push("/")),void 0!==r.path){var i=r.path;t.absolutePath||n&&n.absolutePath||(i=removeDotSegments(i)),void 0===s&&(i=i.replace(/^\/\//,"/%2F")),o.push(i)}return void 0!==r.query&&(o.push("?"),o.push(r.query)),void 0!==r.fragment&&(o.push("#"),o.push(r.fragment)),o.join("")}function resolveComponents(e,r,t,o){void 0===t&&(t={});var n={};return o||(e=parse(serialize(e,t),t),r=parse(serialize(r,t),t)),!(t=t||{}).tolerant&&r.scheme?(n.scheme=r.scheme,n.userinfo=r.userinfo,n.host=r.host,n.port=r.port,n.path=removeDotSegments(r.path||""),n.query=r.query):(void 0!==r.userinfo||void 0!==r.host||void 0!==r.port?(n.userinfo=r.userinfo,n.host=r.host,n.port=r.port,n.path=removeDotSegments(r.path||""),n.query=r.query):(r.path?("/"===r.path.charAt(0)?n.path=removeDotSegments(r.path):(void 0===e.userinfo&&void 0===e.host&&void 0===e.port||e.path?e.path?n.path=e.path.slice(0,e.path.lastIndexOf("/")+1)+r.path:n.path=r.path:n.path="/"+r.path,n.path=removeDotSegments(n.path)),n.query=r.query):(n.path=e.path,void 0!==r.query?n.query=r.query:n.query=e.query),n.userinfo=e.userinfo,n.host=e.host,n.port=e.port),n.scheme=e.scheme),n.fragment=r.fragment,n}function resolve(e,r,t){var o=util_1.assign({scheme:"null"},t);return serialize(resolveComponents(parse(e,o),parse(r,o),o,!0),o)}function normalize(e,r){return"string"==typeof e?e=serialize(parse(e,r),r):"object"===util_1.typeOf(e)&&(e=parse(serialize(e,r),r)),e}function equal(e,r,t){return"string"==typeof e?e=serialize(parse(e,t),t):"object"===util_1.typeOf(e)&&(e=serialize(e,t)),"string"==typeof r?r=serialize(parse(r,t),t):"object"===util_1.typeOf(r)&&(r=serialize(r,t)),e===r}function escapeComponent(e,r){return e&&e.toString().replace(r&&r.iri?regexps_iri_1.default.ESCAPE:regexps_uri_1.default.ESCAPE,pctEncChar)}function unescapeComponent(e,r){return e&&e.toString().replace(r&&r.iri?regexps_iri_1.default.PCT_ENCODED:regexps_uri_1.default.PCT_ENCODED,pctDecChars)}Object.defineProperty(exports,"__esModule",{value:!0});var regexps_uri_1=require("./regexps-uri"),regexps_iri_1=require("./regexps-iri"),punycode_1=require("punycode"),util_1=require("./util");exports.SCHEMES={},exports.pctEncChar=pctEncChar,exports.pctDecChars=pctDecChars;var URI_PARSE=/^(?:([^:\/?#]+):)?(?:\/\/((?:([^\/?#@]*)@)?(\[[^\/?#\]]+\]|[^\/?#:]*)(?:\:(\d*))?))?([^?#]*)(?:\?([^#]*))?(?:#((?:.|\n|\r)*))?/i,NO_MATCH_IS_UNDEFINED=void 0==="".match(/(){0}/)[1];exports.parse=parse;var RDS1=/^\.\.?\//,RDS2=/^\/\.(\/|$)/,RDS3=/^\/\.\.(\/|$)/,RDS4=/^\.\.?$/,RDS5=/^\/?(?:.|\n)*?(?=\/|$)/;exports.removeDotSegments=removeDotSegments,exports.serialize=serialize,exports.resolveComponents=resolveComponents,exports.resolve=resolve,exports.normalize=normalize,exports.equal=equal,exports.escapeComponent=escapeComponent,exports.unescapeComponent=unescapeComponent;