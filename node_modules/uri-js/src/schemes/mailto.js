"use strict";function decodeUnreserved(e){var r=uri_1.pctDecChars(e);return r.match(UNRESERVED)?r:e}Object.defineProperty(exports,"__esModule",{value:!0});var uri_1=require("../uri"),punycode_1=require("punycode"),util_1=require("../util"),O={},isIRI=!0,UNRESERVED$$="[A-Za-z0-9\\-\\.\\_\\~"+(isIRI?"\\xA0-\\u200D\\u2010-\\u2029\\u202F-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF":"")+"]",HEXDIG$$="[0-9A-Fa-f]",PCT_ENCODED$=util_1.subexp(util_1.subexp("%[EFef]"+HEXDIG$$+"%"+HEXDIG$$+HEXDIG$$+"%"+HEXDIG$$+HEXDIG$$)+"|"+util_1.subexp("%[89A-Fa-f]"+HEXDIG$$+"%"+HEXDIG$$+HEXDIG$$)+"|"+util_1.subexp("%"+HEXDIG$$+HEXDIG$$)),ATEXT$$="[A-Za-z0-9\\!\\$\\%\\'\\*\\+\\-\\^\\_\\`\\{\\|\\}\\~]",QTEXT$$="[\\!\\$\\%\\'\\(\\)\\*\\+\\,\\-\\.0-9\\<\\>A-Z\\x5E-\\x7E]",VCHAR$$=util_1.merge(QTEXT$$,'[\\"\\\\]'),DOT_ATOM_TEXT$=util_1.subexp(ATEXT$$+"+"+util_1.subexp("\\."+ATEXT$$+"+")+"*"),QUOTED_PAIR$=util_1.subexp("\\\\"+VCHAR$$),QCONTENT$=util_1.subexp(QTEXT$$+"|"+QUOTED_PAIR$),QUOTED_STRING$=util_1.subexp('\\"'+QCONTENT$+'*\\"'),DTEXT_NO_OBS$$="[\\x21-\\x5A\\x5E-\\x7E]",SOME_DELIMS$$="[\\!\\$\\'\\(\\)\\*\\+\\,\\;\\:\\@]",QCHAR$=util_1.subexp(UNRESERVED$$+"|"+PCT_ENCODED$+"|"+SOME_DELIMS$$),DOMAIN$=util_1.subexp(DOT_ATOM_TEXT$+"|\\["+DTEXT_NO_OBS$$+"*\\]"),LOCAL_PART$=util_1.subexp(DOT_ATOM_TEXT$+"|"+QUOTED_STRING$),ADDR_SPEC$=util_1.subexp(LOCAL_PART$+"\\@"+DOMAIN$),TO$=util_1.subexp(ADDR_SPEC$+util_1.subexp("\\,"+ADDR_SPEC$)+"*"),HFNAME$=util_1.subexp(QCHAR$+"*"),HFVALUE$=HFNAME$,HFIELD$=util_1.subexp(HFNAME$+"\\="+HFVALUE$),HFIELDS2$=util_1.subexp(HFIELD$+util_1.subexp("\\&"+HFIELD$)+"*"),HFIELDS$=util_1.subexp("\\?"+HFIELDS2$),MAILTO_URI=new RegExp("^mailto\\:"+TO$+"?"+HFIELDS$+"?$"),UNRESERVED=new RegExp(UNRESERVED$$,"g"),PCT_ENCODED=new RegExp(PCT_ENCODED$,"g"),NOT_LOCAL_PART=new RegExp(util_1.merge("[^]",ATEXT$$,"[\\.]",'[\\"]',VCHAR$$),"g"),NOT_DOMAIN=new RegExp(util_1.merge("[^]",ATEXT$$,"[\\.]","[\\[]",DTEXT_NO_OBS$$,"[\\]]"),"g"),NOT_HFNAME=new RegExp(util_1.merge("[^]",UNRESERVED$$,SOME_DELIMS$$),"g"),NOT_HFVALUE=NOT_HFNAME,TO=new RegExp("^"+TO$+"$"),HFIELDS=new RegExp("^"+HFIELDS2$+"$"),handler={scheme:"mailto",parse:function(e,r){var u=e,E=u.to=u.path?u.path.split(","):[];if(u.path=void 0,u.query){for(var t=!1,$={},_=u.query.split("&"),i=0,p=_.length;i<p;++i){var a=_[i].split("=");switch(a[0]){case"to":for(var o=a[1].split(","),n=0,s=o.length;n<s;++n)E.push(o[n]);break;case"subject":u.subject=uri_1.unescapeComponent(a[1],r);break;case"body":u.body=uri_1.unescapeComponent(a[1],r);break;default:t=!0,$[uri_1.unescapeComponent(a[0],r)]=uri_1.unescapeComponent(a[1],r)}}t&&(u.headers=$)}u.query=void 0;for(i=0,p=E.length;i<p;++i){var D=E[i].split("@");if(D[0]=uri_1.unescapeComponent(D[0]),r.unicodeSupport)D[1]=uri_1.unescapeComponent(D[1],r).toLowerCase();else try{D[1]=punycode_1.default.toASCII(uri_1.unescapeComponent(D[1],r).toLowerCase())}catch(e){u.error=u.error||"Email address's domain name can not be converted to ASCII via punycode: "+e}E[i]=D.join("@")}return u},serialize:function(e,r){var u=e,E=util_1.toArray(e.to);if(E){for(var t=0,$=E.length;t<$;++t){var _=String(E[t]),i=_.lastIndexOf("@"),p=_.slice(0,i).replace(PCT_ENCODED,decodeUnreserved).replace(PCT_ENCODED,util_1.toUpperCase).replace(NOT_LOCAL_PART,uri_1.pctEncChar),a=_.slice(i+1);try{a=r.iri?punycode_1.default.toUnicode(a):punycode_1.default.toASCII(uri_1.unescapeComponent(a,r).toLowerCase())}catch(e){u.error=u.error||"Email address's domain name can not be converted to "+(r.iri?"Unicode":"ASCII")+" via punycode: "+e}E[t]=p+"@"+a}u.path=E.join(",")}var o=e.headers=e.headers||{};e.subject&&(o.subject=e.subject),e.body&&(o.body=e.body);var n=[];for(var s in o)o[s]!==O[s]&&n.push(s.replace(PCT_ENCODED,decodeUnreserved).replace(PCT_ENCODED,util_1.toUpperCase).replace(NOT_HFNAME,uri_1.pctEncChar)+"="+o[s].replace(PCT_ENCODED,decodeUnreserved).replace(PCT_ENCODED,util_1.toUpperCase).replace(NOT_HFVALUE,uri_1.pctEncChar));return n.length&&(u.query=n.join("&")),u}};exports.default=handler;